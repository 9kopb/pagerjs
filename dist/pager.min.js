/*! pager.js - v0.7.0 - 2012-11-03
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
(function(e){var t=function(t,n){"use strict";var r={};r.page=null,r.now=function(){return Date.now?Date.now():(new Date).valueOf()},r.extendWithPage=function(e){var t=new r.Page;e.$__page__=t,r.page=t},r.navigationFailed=n.observable(),r.showChild=function(e){r.page.showPage(e)};var i={};i.value=n.utils.unwrapObservable,i.arrayValue=function(e){return t.map(e,function(e){return i.value(e)})};var s=function(e){var t,n={},r=/\+/g,i=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(r," "))};while(t=i.exec(e))n[s(t[1])]=s(t[2]);return n},o=function(e){if(!e)return{name:null,params:{}};var t=e.split("?"),n=t[0],r=t[1],i={};return r&&(i=s(r)),{name:n,params:i}};r.ChildManager=function(e,s){this.currentChildO=n.observable(null);var u=this;this.page=s,this.timeStamp=r.now(),this.hideChild=function(){u.currentChild&&u.currentChild.getId()!=="start"&&(u.currentChild.hidePage(function(){}),u.currentChild=null,u.currentChildO(null))},this.showChild=function(n){this.timeStamp=r.now();var s=this.timeStamp,a=u.currentChild;u.currentChild=null;var f=!1,l=o(n[0]),c=l.name,h=null;t.each(e(),function(e,t){if(!f){var n=t.getId();if(n===c||(c===""||c==null)&&n==="start")f=!0,u.currentChild=t;n==="?"&&(h=t)}});var p=!1,d=u,v=function(e,t){if(!f){var n=t.getId(),r=t.getValue().modal;if(r){if(n===c||(c===""||c==null)&&n==="start")f=!0,u.currentChild=t,p=!0;n==="?"&&!h&&(h=t,p=!0)}}};while(!u.currentChild&&d.page.parentPage&&!d.page.getValue().modal){var m=d.page.parentPage.children;t.each(m(),v),u.currentChild||(d=d.page.parentPage.childManager)}!u.currentChild&&h&&(u.currentChild=h),u.currentChild&&(u.currentChildO(u.currentChild),p?u.currentChild.currentParentPage(u.page):u.currentChild.currentParentPage(null));var g=function(){r.navigationFailed&&r.navigationFailed({page:u.page,route:n}),u.page.getValue().navigationFailed&&i.value(u.page.getValue().navigationFailed)(u.page,n)},y=function(){var e=i.value(u.currentChild.getValue().guard);e?e(u.currentChild,n,function(){u.timeStamp===s&&u.currentChild.showPage(n.slice(1),l,n[0])},a):u.currentChild.showPage(n.slice(1),l,n[0])};a&&a===u.currentChild?y():a?a.hidePage(function(){u.currentChild?y():g()}):u.currentChild?y():g()}};var u;r.Page=function(e,t,i,s,o){this.element=e,this.valueAccessor=t,this.allBindingsAccessor=i,this.viewModel=s,this.bindingContext=o,this.children=n.observableArray([]),this.childManager=new r.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=n.observable(null),this.isVisible=n.observable(!1),this.originalRoute=n.observable(null),this.route=null};var a=r.Page.prototype;a.val=function(e){return i.value(this.getValue()[e])},a.currentChildPage=function(){return this.childManager.currentChildO},a.showPage=function(e,t,n){var r=this,i=r.currentId,s=r.pageRoute?r.pageRoute.params:null,o=r.isVisible();r.currentId=t?t.name:null,r.isVisible(!0),r.originalRoute(n),r.route=e,r.pageRoute=t,o?(r.getId()==="?"&&i!==r.currentId&&r.show(),t&&s!==t.params&&r.setParams()):(r.setParams(),r.show()),r.childManager.showChild(e)},a.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var e=this.pageRoute.params,r=this.ctx,i=this.val("params")||{};t.each(e,function(e,s){t.inArray(e,i)!==-1&&(r[e]?r[e](s):r[e]=n.observable(s))})}},a.hidePage=function(e){this.isVisible(!1),this.hideElementWrapper(e),this.childManager.hideChild()},a.init=function(){var e=this;n.utils.domNodeDisposal.addDisposeCallback(e.element,function(){e.parentPage.children.remove(e)});var t=e.getValue();return e.parentPage=e.getParentPage(),e.parentPage.children.push(this),e.hideElement(),e.val("source")&&e.loadSource(e.val("source")),e.ctx=null,t["with"]?(e.ctx=i.value(t["with"]),e.augmentContext()):t.withOnShow?e.ctx={}:(e.ctx=e.viewModel,e.augmentContext()),e.childBindingContext=e.bindingContext.createChildContext(e.ctx),n.utils.extend(e.childBindingContext,{$page:this}),e.val("withOnShow")||n.applyBindingsToDescendants(e.childBindingContext,e.element),e.parentPage.route&&e.parentPage.route[0]===e.getId()&&setTimeout(function(){e.parentPage.showPage(e.parentPage.route)},0),{controlsDescendantBindings:!0}},a.augmentContext=function(){var e=this;e.val("params")&&t.each(this.val("params"),function(t,r){e.ctx[r]||(e.ctx[r]=n.observable())}),this.val("vars")&&t.each(this.val("vars"),function(t,r){e.ctx[t]=n.observable(r)}),this.setParams()},a.getValue=function(){return this.valueAccessor?i.value(this.valueAccessor()):{}},a.getParentPage=function(){var e=this.bindingContext;while(e){if(e.$page)return e.$page;if(e.$data&&e.$data.$__page__)return e.$data.$__page__;e=e.$parentContext}return null},a.getId=function(){return this.val("id")},a.sourceUrl=function(e){var t=this;return this.getId()==="?"?n.computed(function(){var n;return t.val("deep")?n=[t.currentId].concat(t.route).join("/"):n=t.currentId,i.value(e).replace("{1}",n)}):n.computed(function(){return i.value(e)})},a.loadSource=function(e){var s=this.getValue(),o=this,u=this.element,a=null,f=s.loader||r.loader;if(s.frame==="iframe"){var l=t("iframe",t(u));l.length===0&&(l=t("<iframe></iframe>"),t(u).append(l)),f&&(a=i.value(f)(o,l),a.load()),l.one("load",function(){a&&a.unload(),s.sourceLoaded&&s.sourceLoaded(o)}),n.applyBindingsToNode(l[0],{attr:{src:this.sourceUrl(e)}})}else f&&(a=i.value(f)(o,o.element),a.load()),n.computed(function(){var r=function(){a&&a.unload(),n.applyBindingsToDescendants(o.childBindingContext,o.element),s.sourceLoaded&&s.sourceLoaded(o),o.route&&o.childManager.showChild(o.route)};if(typeof i.value(e)=="string"){var f=i.value(this.sourceUrl(e));t(u).load(f,function(){r()})}else i.value(e)(this,function(){r()})},this)},a.show=function(t){var i=this.element,s=this;s.showElementWrapper(t),s.val("title")&&(e.document.title=s.val("title")),s.val("withOnShow")&&(!s.withOnShowLoaded||s.val("sourceCache")!==!0)&&(s.withOnShowLoaded=!0,s.val("withOnShow")(function(e){var t=s.bindingContext.createChildContext(e);s.ctx=e,s.augmentContext(),n.utils.extend(t,{$page:s}),n.applyBindingsToDescendants(t,s.element)},s)),s.val("sourceOnShow")&&(!s.val("sourceCache")||!i.__pagerLoaded__||typeof s.val("sourceCache")=="number"&&i.__pagerLoaded__+s.val("sourceCache")*1e3<r.now())&&(i.__pagerLoaded__=r.now(),s.loadSource(s.val("sourceOnShow")))},a.showElementWrapper=function(e){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(e),this.val("afterShow")&&this.val("afterShow")(this)},a.showElement=function(e){this.val("showElement")?this.val("showElement")(this,e):this.val("fx")?r.fx[this.val("fx")].showElement(this,e):r.showElement?r.showElement(this,e):t(this.element).show(e)},r.Page.prototype.hideElementWrapper=function(e){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(e),this.val("afterHide")&&this.val("afterHide")(this)},a.hideElement=function(e){this.val("hideElement")?this.val("hideElement")(this,e):this.val("fx")?r.fx[this.val("fx")].hideElement(this,e):r.hideElement?r.hideElement(this,e):(t(this.element).hide(),e&&e())},a.getFullRoute=function(){return n.computed(function(){var e=null;return this.currentParentPage&&this.currentParentPage()?(e=this.currentParentPage().getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):this.parentPage?(e=this.parentPage.getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):[]},this)},a.nullObject=new r.Page,a.nullObject.children=n.observableArray([]),a.child=function(e){return n.computed(function(){var n=t.grep(this.children(),function(t){return t.getId()===e})[0];return n||this.nullObject},this)},n.bindingHandlers.page={init:function(e,t,n,i,s){var o=new r.Page(e,t,n,i,s);return o.init()}},r.useHTML5history=!1,r.rootURI="/",r.Href=function(e,t,r,i,s){this.element=e,this.bindingContext=s,this.path=n.observable(),this.val=n.observable(t)};var f=r.Href.prototype;return f.getParentPage=a.getParentPage,f.init=function(){var e=this.getParentPage();this.path=n.computed(function(){var t=i.value(this.val()());if(typeof t=="string"){var n=0;while(t.substring(0,3)==="../")n++,t=t.slice(3);var r=e.getFullRoute()(),s=r.slice(0,r.length-n).join("/"),o=(s===""?"":s+"/")+t;return o}return t.getFullRoute?t.getFullRoute()().join("/"):""},this)},r.Href.hash="#",f.bind=function(){var e=n.computed(function(){return r.Href.hash+this.path()},this);n.applyBindingsToNode(this.element,{attr:{href:e}})},f.update=function(e){this.val(e)},r.Href5=function(e,t,n,i,s){r.Href.apply(this,arguments)},r.Href5.prototype=new r.Href,r.Href5.history=e.history,r.Href5.prototype.bind=function(){var e=this;n.applyBindingsToNode(e.element,{attr:{href:e.path},click:function(){r.Href5.history.pushState(null,null,e.path())}})},n.bindingHandlers["page-hash"]={init:function(e,t,n,i,s){var o=new r.Href(e,t,n,i,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},n.bindingHandlers["page-href5"]={init:function(e,t,n,i,s){var o=new r.Href5(e,t,n,i,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},n.bindingHandlers["page-href"]={init:function(e,t,n,i,s){var o=r.useHTML5history?r.Href5:r.Href,u=new o(e,t,n,i,s);u.init(),u.bind(),e.__ko__page=u},update:function(e,t){e.__ko__page.update(t)}},r.fx={},r.fx.cssAsync=function(e){return{showElement:function(n,r){var i=t(n.element);i.addClass(e),i.show();var s=setInterval(function(){clearInterval(s),i.addClass(e+"-in")},10),o=setInterval(function(){clearInterval(o),r&&r()},300)},hideElement:function(n,r){var i=t(n.element);if(!n.pageHiddenOnce)n.pageHiddenOnce=!0,i.hide();else{i.removeClass(e+"-in");var s=setInterval(function(){clearInterval(s),r&&r(),i.hide()},300)}}}},r.fx.zoom=r.fx.cssAsync("pagerjs-fx-zoom"),r.fx.flip=r.fx.cssAsync("pagerjs-fx-flip"),r.fx.popout=r.fx.cssAsync("pagerjs-fx-popout-modal"),r.fx.jQuerySync=function(e,n){return{showElement:function(n,r){e.call(t(n.element),300,r)},hideElement:function(e,r){n.call(t(e.element),300,function(){t(e.element).hide()}),r&&r()}}},r.fx.slide=r.fx.jQuerySync(t.fn.slideDown,t.fn.slideUp),r.fx.fade=r.fx.jQuerySync(t.fn.fadeIn,t.fn.fadeOut),r.startHistoryJs=function(n){n&&History.pushState(null,null,n);var i=function(e){e.substring(0,r.Href.hash.length)===r.Href.hash&&(e=e.slice(r.Href.hash.length));var t=decodeURIComponent(e).split("/");r.showChild(t)};History.Adapter.bind(e,"statechange",function(){var e=t("base").attr("href"),n=History.getState().url.replace(e,"");i(n)}),History.Adapter.bind(e,"anchorchange",function(){i(location.hash)}),i(History.getState().url.replace(History.getRootUrl(),""))},r.startHashChange=function(n){n&&(location.hash=r.Href.hash+n),t(e).hashchange(function(){var e=location.hash;e.substring(0,r.Href.hash.length)===r.Href.hash&&(e=e.slice(r.Href.hash.length));var t=decodeURIComponent(e).split("/");r.showChild(t)}),t(e).hashchange()},r.start=function(n){n&&(location.hash=r.Href.hash+n);var i=function(e){e.substring(0,r.Href.hash.length)===r.Href.hash&&(e=e.slice(r.Href.hash.length));var t=decodeURIComponent(e).split("/");r.showChild(t)},s=function(){i(e.location.hash)};t(e).bind("hashchange",s),s()},r},n=typeof exports=="object"&&exports&&(typeof global=="object"&&global&&global===global.global&&(e=global),exports);typeof define=="function"&&typeof define.amd=="object"&&define.amd?define(["knockout","jquery"],function(e){return t($,e)}):n?typeof module=="object"&&module&&module.exports==n?(module.exports=pager).pager=pager:n.pager=pager:e.pager=t($,ko)})(this);