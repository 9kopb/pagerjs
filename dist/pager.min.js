/*! pager.js - v0.5.0 - 2012-10-04
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
var pager={};pager.page=null,pager.now=function(){return Date.now?Date.now():(new Date).valueOf()},pager.extendWithPage=function(a){var b=new pager.Page;a.$__page__=b,pager.page=b},pager.navigationFailed=ko.observable(),pager.showChild=function(a){pager.page.childManager.showChild(a)};var _ko={};_ko.value=ko.utils.unwrapObservable,_ko.arrayValue=function(a){return _.map(a,function(a){return _ko.value(a)})};var parseStringAsParameters=function(a){var b,c={},d=/\+/g,e=/([^&=]+)=?([^&]*)/g,f=function(a){return decodeURIComponent(a.replace(d," "))};while(b=e.exec(a))c[f(b[1])]=f(b[2]);return c},splitRoutePartIntoNameAndParameters=function(a){if(!a)return{name:null,params:{}};var b=a.split("?"),c=b[0],d=b[1],e={};return d&&(e=parseStringAsParameters(d)),{name:c,params:e}};pager.ChildManager=function(a,b){this.currentChildO=ko.observable(null);var c=this;this.page=b,this.timeStamp=pager.now(),this.hideChild=function(){c.currentChild&&c.currentChild.getId()!=="start"&&(c.currentChild.hidePage(function(){}),c.currentChild=null,c.currentChildO(null))},this.showChild=function(b){this.timeStamp=pager.now();var d=this.timeStamp,e=c.currentChild;c.currentChild=null;var f=!1,g=splitRoutePartIntoNameAndParameters(b[0]),h=g.name,i=null;_.each(a(),function(a){if(!f){var b=a.getId();if(b===h||(h===""||h==null)&&b==="start")f=!0,c.currentChild=a;b==="?"&&(i=a)}});var j=!1,k=c,l=function(a){if(!f){var b=a.getId(),d=a.getValue().modal;if(d){if(b===h||(h===""||h==null)&&b==="start")f=!0,c.currentChild=a,j=!0;b==="?"&&!i&&(i=a,j=!0)}}};while(!c.currentChild&&k.page.parentPage&&!k.page.getValue().modal){var m=k.page.parentPage.children;_.each(m(),l),c.currentChild||(k=k.page.parentPage.childManager)}!c.currentChild&&i&&(c.currentChild=i,c.currentChild.currentId=h),c.currentChild&&(c.currentChildO(c.currentChild),j?c.currentChild.currentParentPage(c.page):c.currentChild.currentParentPage(null));var n=function(){pager.navigationFailed&&pager.navigationFailed({page:c.page,route:b}),c.page.getValue().navigationFailed&&_ko.value(c.page.getValue().navigationFailed)(c.page,b)},o=function(){var a=_ko.value(c.currentChild.getValue().guard);a?a(c.currentChild,b,function(){c.timeStamp===d&&c.currentChild.showPage(b.slice(1),g,b[0])},e):c.currentChild.showPage(b.slice(1),g,b[0])};e&&e===c.currentChild?o():e?e.hidePage(function(){c.currentChild?o():n()}):c.currentChild?o():n()}};var PageConfig;pager.Page=function(a,b,c,d,e){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=c,this.viewModel=d,this.bindingContext=e,this.children=ko.observableArray([]),this.childManager=new pager.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=ko.observable(null),this.isVisible=ko.observable(!1),this.originalRoute=ko.observable(null),this.route=null};var p=pager.Page.prototype;p.val=function(a){return _ko.value(this.getValue()[a])},p.currentChildPage=function(){return this.childManager.currentChildO},p.showPage=function(a,b,c){this.isVisible(!0),this.originalRoute(c),this.route=a,this.pageRoute=b,this.setParams(),this.show(),this.childManager.showChild(a)},p.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var a=this.pageRoute.params,b=this.ctx,c=this.val("params")||{};$.each(a,function(a,d){_.indexOf(c,a)!==-1&&(b[a]?b[a](d):b[a]=ko.observable(d))})}},p.hidePage=function(a){this.isVisible(!1),this.hideElementWrapper(a),this.childManager.hideChild()},p.init=function(){var a=this,b=a.getValue();return a.parentPage=a.getParentPage(),a.parentPage.children.push(this),a.hideElement(),a.val("source")&&a.loadSource(a.val("source")),a.ctx=null,b["with"]?(a.ctx=_ko.value(b["with"]),a.augmentContext()):b.withOnShow?a.ctx={}:(a.ctx=a.viewModel,a.augmentContext()),a.childBindingContext=a.bindingContext.createChildContext(a.ctx),ko.utils.extend(a.childBindingContext,{$page:this}),a.val("withOnShow")||ko.applyBindingsToDescendants(a.childBindingContext,a.element),{controlsDescendantBindings:!0}},p.augmentContext=function(){var a=this;a.val("params")&&$.each(this.val("params"),function(b,c){a.ctx[c]||(a.ctx[c]=ko.observable())}),this.val("vars")&&$.each(this.val("vars"),function(b,c){a.ctx[b]=ko.observable(c)}),this.setParams()},p.getValue=function(){return this.valueAccessor?_ko.value(this.valueAccessor()):{}},p.getParentPage=function(){var a=this.bindingContext;while(a){if(a.$page)return a.$page;if(a.$data&&a.$data.$__page__)return a.$data.$__page__;a=a.$parentContext}return null},p.getId=function(){return this.val("id")},p.sourceUrl=function(a){var b=this;return this.getId()==="?"?ko.computed(function(){var c;return b.val("deep")?c=b.getFullRoute()().concat(b.route).join("/"):c=b.currentId,_ko.value(a).replace("{1}",c)}):ko.computed(function(){return _ko.value(a)})},p.loadSource=function(a){var b=this.getValue(),c=this,d=this.element,e=null,f=b.loader||pager.loader;if(b.frame==="iframe"){var g=$("iframe",$(d));g.length===0&&(g=$("<iframe></iframe>"),$(d).append(g)),f&&(e=_ko.value(f)(c,g),e.load()),b.sourceLoaded&&g.one("load",function(){e&&e.unload(),b.sourceLoaded(c)}),ko.applyBindingsToNode(g[0],{attr:{src:this.sourceUrl(a)}})}else f&&(e=_ko.value(f)(c,c.element),e.load()),ko.computed(function(){var f=function(){e&&e.unload(),ko.applyBindingsToDescendants(c.childBindingContext,c.element),b.sourceLoaded&&b.sourceLoaded(c),c.route&&c.childManager.showChild(c.route)};if(typeof _ko.value(a)=="string"){var g=_ko.value(this.sourceUrl(a));$(d).load(g,function(){f()})}else _ko.value(a)(this,function(){f()})},this)},p.show=function(a){var b=this.element,c=this;c.showElementWrapper(a),c.val("title")&&(window.document.title=c.val("title")),c.val("withOnShow")&&(!c.withOnShowLoaded||c.val("sourceCache")!==!0)&&(c.withOnShowLoaded=!0,c.val("withOnShow")(_.bind(function(a){var b=c.bindingContext.createChildContext(a);c.ctx=a,c.augmentContext(),ko.utils.extend(b,{$page:this}),ko.applyBindingsToDescendants(b,c.element)},this),this)),c.val("sourceOnShow")&&(!c.val("sourceCache")||!b.__pagerLoaded__||typeof c.val("sourceCache")=="number"&&b.__pagerLoaded__+c.val("sourceCache")*1e3<pager.now())&&(b.__pagerLoaded__=pager.now(),c.loadSource(c.val("sourceOnShow")))},p.showElementWrapper=function(a){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(a),this.val("afterShow")&&this.val("afterShow")(this)},p.showElement=function(a){this.val("showElement")?this.val("showElement")(this,a):this.val("fx")?pager.fx[this.val("fx")].showElement(this,a):pager.showElement?pager.showElement(this,a):$(this.element).show(a)},pager.Page.prototype.hideElementWrapper=function(a){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(a),this.val("afterHide")&&this.val("afterHide")(this)},p.hideElement=function(a){this.val("hideElement")?this.val("hideElement")(this,a):this.val("fx")?pager.fx[this.val("fx")].hideElement(this,a):pager.hideElement?pager.hideElement(this,a):($(this.element).hide(),a&&a())},p.getFullRoute=function(){return ko.computed(function(){var a=null;return this.currentParentPage&&this.currentParentPage()?(a=this.currentParentPage().getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):this.parentPage?(a=this.parentPage.getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):[]},this)},p.nullObject=new pager.Page,p.nullObject.children=ko.observableArray([]),p.child=function(a){return ko.computed(function(){var b=_.find(this.children(),function(b){return b.getId()===a});return b||this.nullObject},this)},ko.bindingHandlers.page={init:function(a,b,c,d,e){var f=new pager.Page(a,b,c,d,e);return f.init()},update:function(){}},pager.useHTML5history=!1,pager.rootURI="/",pager.Href=function(a,b,c,d,e){this.element=a,this.bindingContext=e,this.path=ko.observable(),this.val=ko.observable(b)};var hp=pager.Href.prototype;hp.getParentPage=p.getParentPage,hp.init=function(){var a=this.getParentPage();this.path=ko.computed(function(){var b=_ko.value(this.val()());if(typeof b=="string"){var c=0;while(b.substring(0,3)==="../")c++,b=b.slice(3);var d=a.getFullRoute()(),e=d.slice(0,d.length-c).join("/"),f=(e===""?"":e+"/")+b;return f}return b.getFullRoute?b.getFullRoute()().join("/"):""},this)},pager.Href.hash="#",hp.bind=function(){var a=ko.computed(function(){return pager.Href.hash+this.path()},this);ko.applyBindingsToNode(this.element,{attr:{href:a}})},hp.update=function(a){this.val(a)},pager.Href5=function(a,b,c,d,e){pager.Href.apply(this,arguments)},pager.Href5.prototype=new pager.Href,pager.Href5.history=window.history,pager.Href5.prototype.bind=function(){ko.applyBindingsToNode(this.element,{attr:{href:this.path},click:_.bind(function(){pager.Href5.history.pushState(null,null,this.path())},this)})},ko.bindingHandlers["page-hash"]={init:function(a,b,c,d,e){var f=new pager.Href(a,b,c,d,e);f.init(),f.bind(),a.__ko__page=f},update:function(a,b){a.__ko__page.update(b)}},ko.bindingHandlers["page-href5"]={init:function(a,b,c,d,e){var f=new pager.Href5(a,b,c,d,e);f.init(),f.bind(),a.__ko__page=f},update:function(a,b){a.__ko__page.update(b)}},ko.bindingHandlers["page-href"]={init:function(a,b,c,d,e){var f=pager.useHTML5history?pager.Href5:pager.Href,g=new f(a,b,c,d,e);g.init(),g.bind(),a.__ko__page=g},update:function(a,b){a.__ko__page.update(b)}},pager.fx={},pager.fx.cssAsync=function(a){return{showElement:function(b,c){var d=$(b.element);d.addClass(a),d.show();var e=setInterval(function(){clearInterval(e),d.addClass(a+"-in")},10),f=setInterval(function(){clearInterval(f),c&&c()},300)},hideElement:function(b,c){var d=$(b.element);if(!b.pageHiddenOnce)b.pageHiddenOnce=!0,d.hide();else{d.removeClass(a+"-in");var e=setInterval(function(){clearInterval(e),c&&c(),d.hide()},300)}}}},pager.fx.zoom=pager.fx.cssAsync("pagerjs-fx-zoom"),pager.fx.flip=pager.fx.cssAsync("pagerjs-fx-flip"),pager.fx.popout=pager.fx.cssAsync("pagerjs-fx-popout-modal"),pager.fx.jQuerySync=function(a,b){return{showElement:function(b,c){a.call($(b.element),300,c)},hideElement:function(a,c){b.call($(a.element),300,function(){$(a.element).hide()}),c&&c()}}},pager.fx.slide=pager.fx.jQuerySync($.fn.slideDown,$.fn.slideUp),pager.fx.fade=pager.fx.jQuerySync($.fn.fadeIn,$.fn.fadeOut),pager.routeFromHashToPage=function(a){a.substring(0,pager.Href.hash.length)===pager.Href.hash&&(a=a.slice(pager.Href.hash.length));var b=decodeURIComponent(a).split("/");pager.showChild(b)},pager.start=function(){var a=function(){pager.routeFromHashToPage(window.location.hash)};$(window).bind("hashchange",a),a()};