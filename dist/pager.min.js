/*! pager.js - v0.1.0 - 2012-08-14
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
var pager={},_ko={};_ko.value=ko.utils.unwrapObservable,_ko.arrayValue=function(a){return _.map(a,function(a){return _ko.value(a)})},pager.ChildManager=function(a,b){var c=null;this.showChild=function(){c&&(c.hide(),c=null);var d=!1,e=b()[0],f=null;_.each(a(),function(a){if(!d){var b=_ko.value(_ko.value(a.valueAccessor()).id);if(b===e||(e===""||e==null)&&b==="start")d=!0,c=a;b==="?"&&(f=a)}}),c||(c=f),c&&c.show()}},pager.start=function(a){var b=function(){pager.route(a.$page,window.location.hash)};$(window).bind("hashchange",b),b()},pager.extendWithPage=function(a){a.$page=ko.observable({children:ko.observableArray([]),route:ko.observableArray([]),parentRoute:ko.observableArray([]),__id__:Math.random()}),pager.childManager=new pager.ChildManager(a.$page().children,a.$page().route)},pager.route=function(a,b){b[0]==="#"&&(b=b.slice(1));var c=b.split("/");a().route(c),pager.childManager.showChild()},pager.Page=function(a,b,c,d,e){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=c,this.viewModel=d,this.bindingContext=e},pager.Page.prototype.init=function(){var a=this.getValue(),b=this.getPage(),c=ko.observableArray([]),d=ko.observableArray([]),e=this.element;b.children.push({valueAccessor:this.valueAccessor,element:e,page:b,show:_.bind(function(){this.show(),f.showChild()},this),hide:_.bind(function(){this.hideElement()},this)}),ko.computed(function(){c(b.route().slice(1));var e=_ko.value(a).id;if(b.parentRoute){var f=b.parentRoute().slice(0);f.push(e),d(f)}else d([e])});var f=null,g={$page:ko.observable({children:ko.observableArray([]),parentRoute:d,route:c,__id__:Math.random()})};this.pagerValues=g,this.hideElement(),f=new pager.ChildManager(g.$page().children,c),a.source&&this.loadSource(a.source);var h=null;return a["with"]?h=_ko.value(a["with"]):a.withOnShow?h={}:h=this.viewModel,this.childBindingContext=this.bindingContext.createChildContext(h),ko.utils.extend(this.childBindingContext,g),ko.applyBindingsToDescendants(this.childBindingContext,e),{controlsDescendantBindings:!0}},pager.Page.prototype.getValue=function(){return _ko.value(this.valueAccessor())},pager.Page.prototype.getPage=function(){return(this.bindingContext.$page||this.bindingContext.$data.$page)()},pager.Page.prototype.sourceUrl=function(a){var b=this.getValue(),c=this.getPage();return _ko.value(b).id==="?"?ko.computed(function(){return _ko.value(a).replace("{1}",c.route()[0])}):ko.computed(function(){return _ko.value(a)})},pager.Page.prototype.loadSource=function(a){var b=this.getValue(),c=this,d=this.element;if(b.frame==="iframe"){var e=$("iframe",$(d));e.length===0&&(e=$("<iframe></iframe>"),$(d).append(e)),b.sourceLoaded&&e.one("load",b.sourceLoaded),ko.applyBindingsToNode(e[0],{attr:{src:this.sourceUrl(a)}})}else ko.computed(function(){var e=_ko.value(this.sourceUrl(a));$(d).load(e,function(){ko.applyBindingsToDescendants(c.childBindingContext,c.element),b.sourceLoaded&&b.sourceLoaded.apply(c,arguments)})},this)},pager.Page.prototype.show=function(){var a=this.element,b=this.getValue(),c=$(a);this.isVisible()||(this.showElement(),b.withOnShow&&(this.withOnShowLoaded||(this.withOnShowLoaded=!0,b.withOnShow(_.bind(function(a){var b=this.bindingContext.createChildContext(a);ko.utils.extend(b,this.pagerValues),ko.applyBindingsToDescendants(b,this.element)},this)))),b.sourceOnShow&&(!b.sourceCache||!a.__pagerLoaded__||typeof b.sourceCache=="number"&&a.__pagerLoaded__+b.sourceCache*1e3<Date.now())&&(a.__pagerLoaded__=Date.now(),this.loadSource(b.sourceOnShow)))},pager.Page.prototype.showElement=function(){$(this.element).show()},pager.Page.prototype.hideElement=function(){$(this.element).hide()},pager.Page.prototype.isVisible=function(){return $(this.element).is(":visible")},ko.bindingHandlers.page={init:function(a,b,c,d,e){var f=new pager.Page(a,b,c,d,e);return f.init()},update:function(a,b,c,d,e){}},ko.bindingHandlers["page-href"]={init:function(a,b,c,d,e){var f=e.$page||e.$data.$page,g=f();ko.computed(function(){var c=ko.utils.unwrapObservable(b()),d=0;while(c.substring(0,3)==="../")d++,c=c.slice(3);var e=_ko.arrayValue(g.parentRoute().slice(0,g.parentRoute().length-d)).join("/");$(a).attr({href:"#"+(e===""?"":e+"/")+c})})},update:function(){}},pager.PageAccordionItem=function(a,b,c,d,e){pager.Page.apply(this,arguments)},pager.PageAccordionItem.prototype=new pager.Page,pager.PageAccordionItem.prototype.getAccordionBody=function(){return $(this.element).children()[1]},pager.PageAccordionItem.prototype.hideElement=function(){this.pageAccordionItemHidden?$(this.getAccordionBody()).slideUp():(this.pageAccordionItemHidden=!0,$(this.getAccordionBody()).hide())},pager.PageAccordionItem.prototype.showElement=function(){$(this.getAccordionBody()).slideDown()},pager.PageAccordionItem.prototype.isVisible=function(){return $(this.getAccordionBody()).is(":visible")},ko.bindingHandlers["page-accordion-item"]={init:function(a,b,c,d,e){var f=new pager.PageAccordionItem(a,b,c,d,e);f.init()},update:function(){}};