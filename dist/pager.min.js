/*! pager.js - v0.3.0 - 2012-09-03
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
var pager={},_ko={};_ko.value=ko.utils.unwrapObservable,_ko.arrayValue=function(a){return _.map(a,function(a){return _ko.value(a)})};var parseStringAsParameters=function(a){var b,c={},d=/\+/g,e=/([^&=]+)=?([^&]*)/g,f=function(a){return decodeURIComponent(a.replace(d," "))};while(b=e.exec(a))c[f(b[1])]=f(b[2]);return c},splitRoutePartIntoNameAndParameters=function(a){if(!a)return{name:null,params:{}};var b=a.split("?"),c=b[0],d=b[1],e={};return d&&(e=parseStringAsParameters(d)),{name:c,params:e}};pager.ChildManager=function(a,b){this.currentChildO=ko.observable(null);var c=this;this.page=b,this.hideChild=function(){c.currentChild&&c.currentChild.getId()!=="start"&&(c.currentChild.hidePage(function(){}),c.currentChild=null,c.currentChildO(null))},this.showChild=function(b){var d=c.currentChild;c.currentChild=null;var e=!1,f=splitRoutePartIntoNameAndParameters(b[0]),g=f.name,h=null;_.each(a(),function(a){if(!e){var b=a.getId();if(b===g||(g===""||g==null)&&b==="start")e=!0,c.currentChild=a;b==="?"&&(h=a)}});var i=!1,j=c;while(!c.currentChild&&j.page.parentPage&&!j.page.getValue().modal){var k=j.page.parentPage.children;_.each(k(),function(a){if(!e){var b=a.getId(),d=a.getValue().modal;if(d){if(b===g||(g===""||g==null)&&b==="start")e=!0,c.currentChild=a,i=!0;b==="?"&&!h&&(h=a,i=!0)}}}),c.currentChild||(j=j.page.parentPage.childManager)}!c.currentChild&&h&&(c.currentChild=h,c.currentChild.currentId=g),c.currentChild&&(c.currentChildO(c.currentChild),i?c.currentChild.currentParentPage(c.page):c.currentChild.currentParentPage(null));var l=function(){pager.navigationFailed&&pager.navigationFailed(c.page,b),c.page.getValue().navigationFailed&&_ko.value(c.page.getValue().navigationFailed)(c.page,b)},m=function(){c.currentChild.showPage(b.slice(1),f,b[0])};d&&d===c.currentChild?m():d?d.hidePage(function(){c.currentChild?m():l()}):c.currentChild?m():l()}},pager.start=function(){var a=function(){pager.routeFromHashToPage(window.location.hash)};$(window).bind("hashchange",a),a()},pager.extendWithPage=function(a){a.$__page__=new pager.Page,pager.childManager=new pager.ChildManager(a.$__page__.children,a.$__page__),a.$__page__.childManager=pager.childManager},pager.navigationFailed=null,pager.routeFromHashToPage=function(a){a[0]==="#"&&(a=a.slice(1));var b=decodeURIComponent(a).split("/");pager.childManager.showChild(b)},pager.Page=function(a,b,c,d,e){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=c,this.viewModel=d,this.bindingContext=e,this.children=ko.observableArray([]),this.childManager=new pager.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx,this.currentParentPage=ko.observable(null),this.isVisible=ko.observable(!1),this.originalRoute=ko.observable(null)},pager.Page.prototype.showPage=function(a,b,c){this.isVisible(!0),this.originalRoute(c),b&&b.params&&this.setParams(b.params),this.show(),this.childManager.showChild(a)},pager.Page.prototype.setParams=function(a){var b=this.ctx,c=this.getValue().params||{};$.each(a,function(a,d){_.indexOf(c,a)!==-1&&(b[a]?b[a](d):b[a]=ko.observable(d))})},pager.Page.prototype.hidePage=function(a){this.isVisible(!1),this.hideElementWrapper(a),this.childManager.hideChild()},pager.Page.prototype.init=function(){var a=this,b=this.getValue();return this.parentPage=this.getParentPage(),this.parentPage.children.push(this),this.hideElement(),b.source&&this.loadSource(b.source),this.ctx=null,b["with"]?this.ctx=_ko.value(b["with"]):b.withOnShow?this.ctx={}:this.ctx=this.viewModel,b.params&&$.each(b.params,function(b,c){a.ctx[c]||(a.ctx[c]=ko.observable())}),this.childBindingContext=this.bindingContext.createChildContext(this.ctx),ko.utils.extend(this.childBindingContext,{$page:this}),b.withOnShow||ko.applyBindingsToDescendants(this.childBindingContext,this.element),{controlsDescendantBindings:!0}},pager.Page.prototype.getValue=function(){return this.valueAccessor?_ko.value(this.valueAccessor()):{}},pager.Page.prototype.getParentPage=function(){var a=this.bindingContext;while(a){if(a.$page)return a.$page;if(a.$data&&a.$data.$__page__)return a.$data.$__page__;a=a.$parentContext}return null},pager.Page.prototype.getId=function(){return _ko.value(this.getValue().id)},pager.Page.prototype.sourceUrl=function(a){var b=this;return this.getId()==="?"?ko.computed(function(){return _ko.value(a).replace("{1}",b.currentId)}):ko.computed(function(){return _ko.value(a)})},pager.Page.prototype.loadSource=function(a){var b=this.getValue(),c=this,d=this.element,e=null,f=b.loader||pager.loader;if(b.frame==="iframe"){var g=$("iframe",$(d));g.length===0&&(g=$("<iframe></iframe>"),$(d).append(g)),f&&(e=_ko.value(f)(c,g),e.load()),b.sourceLoaded&&g.one("load",function(){e&&e.unload(),b.sourceLoaded()}),ko.applyBindingsToNode(g[0],{attr:{src:this.sourceUrl(a)}})}else f&&(e=_ko.value(f)(c,c.element),e.load()),ko.computed(function(){if(typeof _ko.value(a)=="string"){var f=_ko.value(this.sourceUrl(a));$(d).load(f,function(){e&&e.unload(),ko.applyBindingsToDescendants(c.childBindingContext,c.element),b.sourceLoaded&&b.sourceLoaded.apply(c,arguments)})}else _ko.value(a)(this,function(){b.sourceLoaded&&b.sourceLoaded()})},this)},pager.Page.prototype.show=function(a){var b=this.element,c=this,d=this.getValue();this.showElementWrapper(a),this.getValue().title&&(window.document.title=this.getValue().title),d.withOnShow&&(this.withOnShowLoaded||(this.withOnShowLoaded=!0,d.withOnShow(_.bind(function(a){var b=this.bindingContext.createChildContext(a);c.ctx=a,ko.utils.extend(b,{$page:this}),ko.applyBindingsToDescendants(b,this.element)},this)))),d.sourceOnShow&&(!d.sourceCache||!b.__pagerLoaded__||typeof d.sourceCache=="number"&&b.__pagerLoaded__+d.sourceCache*1e3<Date.now())&&(b.__pagerLoaded__=Date.now(),this.loadSource(d.sourceOnShow))},pager.Page.prototype.showElementWrapper=function(a){this.getValue().beforeShow&&this.getValue().beforeShow(this),this.showElement(a),this.getValue().afterShow&&this.getValue().afterShow(this)},pager.Page.prototype.showElement=function(a){this.getValue().showElement?this.getValue().showElement(this,a):pager.showElement?pager.showElement(this,a):$(this.element).show(a)},pager.Page.prototype.hideElementWrapper=function(a){this.getValue().beforeHide&&this.getValue().beforeHide(this),this.hideElement(a),this.getValue().afterHide&&this.getValue().afterHide(this)},pager.Page.prototype.hideElement=function(a){this.getValue().hideElement?this.getValue().hideElement(this,a):pager.hideElement?pager.hideElement(this,a):($(this.element).hide(),a&&a())},pager.Page.prototype.getFullRoute=function(){return ko.computed(function(){var a=null;return this.currentParentPage&&this.currentParentPage()?(a=this.currentParentPage().getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):this.parentPage?(a=this.parentPage.getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):[]},this)},ko.bindingHandlers.page={init:function(a,b,c,d,e){var f=new pager.Page(a,b,c,d,e);return f.init()},update:function(a,b,c,d,e){}},pager.useHTML5history=!1,pager.rootURI="/",ko.bindingHandlers["page-href"]={init:function(a,b,c,d,e){var f=e.$page||e.$data.$page,g=f,h=ko.computed(function(){var c=_ko.value(b()),d=0;while(c.substring(0,3)==="../")d++,c=c.slice(3);var e=g.getFullRoute()(),f=e.slice(0,e.length-d).join("/"),h=(f===""?"":f+"/")+c,i={href:"#"+h};return $(a).attr(i),h});pager.useHTML5history&&window.history&&history.pushState&&$(a).click(function(a){a.preventDefault(),history.pushState(null,null,pager.rootURI+h()),pager.childManager.showChild(h().split("/"))})},update:function(){}},pager.PageAccordionItem=function(a,b,c,d,e){pager.Page.apply(this,arguments)},pager.PageAccordionItem.prototype=new pager.Page,pager.PageAccordionItem.prototype.getAccordionBody=function(){return $(this.element).children()[1]},pager.PageAccordionItem.prototype.hideElement=function(a){this.pageAccordionItemHidden?($(this.getAccordionBody()).slideUp(),a&&a()):(this.pageAccordionItemHidden=!0,$(this.getAccordionBody()).hide())},pager.PageAccordionItem.prototype.showElement=function(a){$(this.getAccordionBody()).slideDown(),a&&a()},ko.bindingHandlers["page-accordion-item"]={init:function(a,b,c,d,e){var f=new pager.PageAccordionItem(a,b,c,d,e);f.init()},update:function(){}};