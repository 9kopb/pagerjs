/*! pager.js - v0.5.0 - 2012-10-06
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
var pager={};pager.page=null,pager.now=function(){return Date.now?Date.now():(new Date).valueOf()},pager.extendWithPage=function(e){var t=new pager.Page;e.$__page__=t,pager.page=t},pager.navigationFailed=ko.observable(),pager.showChild=function(e){pager.page.childManager.showChild(e)};var _ko={};_ko.value=ko.utils.unwrapObservable,_ko.arrayValue=function(e){return _.map(e,function(e){return _ko.value(e)})};var parseStringAsParameters=function(e){var t,n={},r=/\+/g,i=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(r," "))};while(t=i.exec(e))n[s(t[1])]=s(t[2]);return n},splitRoutePartIntoNameAndParameters=function(e){if(!e)return{name:null,params:{}};var t=e.split("?"),n=t[0],r=t[1],i={};return r&&(i=parseStringAsParameters(r)),{name:n,params:i}};pager.ChildManager=function(e,t){this.currentChildO=ko.observable(null);var n=this;this.page=t,this.timeStamp=pager.now(),this.hideChild=function(){n.currentChild&&n.currentChild.getId()!=="start"&&(n.currentChild.hidePage(function(){}),n.currentChild=null,n.currentChildO(null))},this.showChild=function(t){this.timeStamp=pager.now();var r=this.timeStamp,i=n.currentChild;n.currentChild=null;var s=!1,o=splitRoutePartIntoNameAndParameters(t[0]),u=o.name,a=null;_.each(e(),function(e){if(!s){var t=e.getId();if(t===u||(u===""||u==null)&&t==="start")s=!0,n.currentChild=e;t==="?"&&(a=e)}});var f=!1,l=n,c=function(e){if(!s){var t=e.getId(),r=e.getValue().modal;if(r){if(t===u||(u===""||u==null)&&t==="start")s=!0,n.currentChild=e,f=!0;t==="?"&&!a&&(a=e,f=!0)}}};while(!n.currentChild&&l.page.parentPage&&!l.page.getValue().modal){var h=l.page.parentPage.children;_.each(h(),c),n.currentChild||(l=l.page.parentPage.childManager)}!n.currentChild&&a&&(n.currentChild=a,n.currentChild.currentId=u),n.currentChild&&(n.currentChildO(n.currentChild),f?n.currentChild.currentParentPage(n.page):n.currentChild.currentParentPage(null));var p=function(){pager.navigationFailed&&pager.navigationFailed({page:n.page,route:t}),n.page.getValue().navigationFailed&&_ko.value(n.page.getValue().navigationFailed)(n.page,t)},d=function(){var e=_ko.value(n.currentChild.getValue().guard);e?e(n.currentChild,t,function(){n.timeStamp===r&&n.currentChild.showPage(t.slice(1),o,t[0])},i):n.currentChild.showPage(t.slice(1),o,t[0])};i&&i===n.currentChild?d():i?i.hidePage(function(){n.currentChild?d():p()}):n.currentChild?d():p()}};var PageConfig;pager.Page=function(e,t,n,r,i){this.element=e,this.valueAccessor=t,this.allBindingsAccessor=n,this.viewModel=r,this.bindingContext=i,this.children=ko.observableArray([]),this.childManager=new pager.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=ko.observable(null),this.isVisible=ko.observable(!1),this.originalRoute=ko.observable(null),this.route=null};var p=pager.Page.prototype;p.val=function(e){return _ko.value(this.getValue()[e])},p.currentChildPage=function(){return this.childManager.currentChildO},p.showPage=function(e,t,n){var r=this.isVisible();this.isVisible(!0),this.originalRoute(n),this.route=e,this.pageRoute=t,r||(this.setParams(),this.show()),this.childManager.showChild(e)},p.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var e=this.pageRoute.params,t=this.ctx,n=this.val("params")||{};$.each(e,function(e,r){_.indexOf(n,e)!==-1&&(t[e]?t[e](r):t[e]=ko.observable(r))})}},p.hidePage=function(e){this.isVisible(!1),this.hideElementWrapper(e),this.childManager.hideChild()},p.init=function(){var e=this;ko.utils.domNodeDisposal.addDisposeCallback(e.element,function(){e.parentPage.children.remove(e)});var t=e.getValue();return e.parentPage=e.getParentPage(),e.parentPage.children.push(this),e.hideElement(),e.val("source")&&e.loadSource(e.val("source")),e.ctx=null,t["with"]?(e.ctx=_ko.value(t["with"]),e.augmentContext()):t.withOnShow?e.ctx={}:(e.ctx=e.viewModel,e.augmentContext()),e.childBindingContext=e.bindingContext.createChildContext(e.ctx),ko.utils.extend(e.childBindingContext,{$page:this}),e.val("withOnShow")||ko.applyBindingsToDescendants(e.childBindingContext,e.element),{controlsDescendantBindings:!0}},p.augmentContext=function(){var e=this;e.val("params")&&$.each(this.val("params"),function(t,n){e.ctx[n]||(e.ctx[n]=ko.observable())}),this.val("vars")&&$.each(this.val("vars"),function(t,n){e.ctx[t]=ko.observable(n)}),this.setParams()},p.getValue=function(){return this.valueAccessor?_ko.value(this.valueAccessor()):{}},p.getParentPage=function(){var e=this.bindingContext;while(e){if(e.$page)return e.$page;if(e.$data&&e.$data.$__page__)return e.$data.$__page__;e=e.$parentContext}return null},p.getId=function(){return this.val("id")},p.sourceUrl=function(e){var t=this;return this.getId()==="?"?ko.computed(function(){var n;return t.val("deep")?n=[t.currentId].concat(t.route).join("/"):n=t.currentId,_ko.value(e).replace("{1}",n)}):ko.computed(function(){return _ko.value(e)})},p.loadSource=function(e){var t=this.getValue(),n=this,r=this.element,i=null,s=t.loader||pager.loader;if(t.frame==="iframe"){var o=$("iframe",$(r));o.length===0&&(o=$("<iframe></iframe>"),$(r).append(o)),s&&(i=_ko.value(s)(n,o),i.load()),t.sourceLoaded&&o.one("load",function(){i&&i.unload(),t.sourceLoaded(n)}),ko.applyBindingsToNode(o[0],{attr:{src:this.sourceUrl(e)}})}else s&&(i=_ko.value(s)(n,n.element),i.load()),ko.computed(function(){var s=function(){i&&i.unload(),ko.applyBindingsToDescendants(n.childBindingContext,n.element),t.sourceLoaded&&t.sourceLoaded(n),n.route&&n.childManager.showChild(n.route)};if(typeof _ko.value(e)=="string"){var o=_ko.value(this.sourceUrl(e));$(r).load(o,function(){s()})}else _ko.value(e)(this,function(){s()})},this)},p.show=function(e){var t=this.element,n=this;n.showElementWrapper(e),n.val("title")&&(window.document.title=n.val("title")),n.val("withOnShow")&&(!n.withOnShowLoaded||n.val("sourceCache")!==!0)&&(n.withOnShowLoaded=!0,n.val("withOnShow")(_.bind(function(e){var t=n.bindingContext.createChildContext(e);n.ctx=e,n.augmentContext(),ko.utils.extend(t,{$page:this}),ko.applyBindingsToDescendants(t,n.element)},this),this)),n.val("sourceOnShow")&&(!n.val("sourceCache")||!t.__pagerLoaded__||typeof n.val("sourceCache")=="number"&&t.__pagerLoaded__+n.val("sourceCache")*1e3<pager.now())&&(t.__pagerLoaded__=pager.now(),n.loadSource(n.val("sourceOnShow")))},p.showElementWrapper=function(e){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(e),this.val("afterShow")&&this.val("afterShow")(this)},p.showElement=function(e){this.val("showElement")?this.val("showElement")(this,e):this.val("fx")?pager.fx[this.val("fx")].showElement(this,e):pager.showElement?pager.showElement(this,e):$(this.element).show(e)},pager.Page.prototype.hideElementWrapper=function(e){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(e),this.val("afterHide")&&this.val("afterHide")(this)},p.hideElement=function(e){this.val("hideElement")?this.val("hideElement")(this,e):this.val("fx")?pager.fx[this.val("fx")].hideElement(this,e):pager.hideElement?pager.hideElement(this,e):($(this.element).hide(),e&&e())},p.getFullRoute=function(){return ko.computed(function(){var e=null;return this.currentParentPage&&this.currentParentPage()?(e=this.currentParentPage().getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):this.parentPage?(e=this.parentPage.getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):[]},this)},p.nullObject=new pager.Page,p.nullObject.children=ko.observableArray([]),p.child=function(e){return ko.computed(function(){var t=_.find(this.children(),function(t){return t.getId()===e});return t||this.nullObject},this)},ko.bindingHandlers.page={init:function(e,t,n,r,i){var s=new pager.Page(e,t,n,r,i);return s.init()}},pager.useHTML5history=!1,pager.rootURI="/",pager.Href=function(e,t,n,r,i){this.element=e,this.bindingContext=i,this.path=ko.observable(),this.val=ko.observable(t)};var hp=pager.Href.prototype;hp.getParentPage=p.getParentPage,hp.init=function(){var e=this.getParentPage();this.path=ko.computed(function(){var t=_ko.value(this.val()());if(typeof t=="string"){var n=0;while(t.substring(0,3)==="../")n++,t=t.slice(3);var r=e.getFullRoute()(),i=r.slice(0,r.length-n).join("/"),s=(i===""?"":i+"/")+t;return s}return t.getFullRoute?t.getFullRoute()().join("/"):""},this)},pager.Href.hash="#",hp.bind=function(){var e=ko.computed(function(){return pager.Href.hash+this.path()},this);ko.applyBindingsToNode(this.element,{attr:{href:e}})},hp.update=function(e){this.val(e)},pager.Href5=function(e,t,n,r,i){pager.Href.apply(this,arguments)},pager.Href5.prototype=new pager.Href,pager.Href5.history=window.history,pager.Href5.prototype.bind=function(){ko.applyBindingsToNode(this.element,{attr:{href:this.path},click:_.bind(function(){pager.Href5.history.pushState(null,null,this.path())},this)})},ko.bindingHandlers["page-hash"]={init:function(e,t,n,r,i){var s=new pager.Href(e,t,n,r,i);s.init(),s.bind(),e.__ko__page=s},update:function(e,t){e.__ko__page.update(t)}},ko.bindingHandlers["page-href5"]={init:function(e,t,n,r,i){var s=new pager.Href5(e,t,n,r,i);s.init(),s.bind(),e.__ko__page=s},update:function(e,t){e.__ko__page.update(t)}},ko.bindingHandlers["page-href"]={init:function(e,t,n,r,i){var s=pager.useHTML5history?pager.Href5:pager.Href,o=new s(e,t,n,r,i);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},pager.fx={},pager.fx.cssAsync=function(e){return{showElement:function(t,n){var r=$(t.element);r.addClass(e),r.show();var i=setInterval(function(){clearInterval(i),r.addClass(e+"-in")},10),s=setInterval(function(){clearInterval(s),n&&n()},300)},hideElement:function(t,n){var r=$(t.element);if(!t.pageHiddenOnce)t.pageHiddenOnce=!0,r.hide();else{r.removeClass(e+"-in");var i=setInterval(function(){clearInterval(i),n&&n(),r.hide()},300)}}}},pager.fx.zoom=pager.fx.cssAsync("pagerjs-fx-zoom"),pager.fx.flip=pager.fx.cssAsync("pagerjs-fx-flip"),pager.fx.popout=pager.fx.cssAsync("pagerjs-fx-popout-modal"),pager.fx.jQuerySync=function(e,t){return{showElement:function(t,n){e.call($(t.element),300,n)},hideElement:function(e,n){t.call($(e.element),300,function(){$(e.element).hide()}),n&&n()}}},pager.fx.slide=pager.fx.jQuerySync($.fn.slideDown,$.fn.slideUp),pager.fx.fade=pager.fx.jQuerySync($.fn.fadeIn,$.fn.fadeOut),pager.routeFromHashToPage=function(e){e.substring(0,pager.Href.hash.length)===pager.Href.hash&&(e=e.slice(pager.Href.hash.length));var t=decodeURIComponent(e).split("/");pager.showChild(t)},pager.start=function(){var e=function(){pager.routeFromHashToPage(window.location.hash)};$(window).bind("hashchange",e),e()};