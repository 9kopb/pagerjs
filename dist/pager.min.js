/*! pager.js - v0.3.0 - 2012-09-01
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
var pager={},_ko={};_ko.value=ko.utils.unwrapObservable,_ko.arrayValue=function(a){return _.map(a,function(a){return _ko.value(a)})},pager.ChildManager=function(a,b){this.currentChildO=ko.observable(null);var c=this;this.page=b,this.hideChild=function(){c.currentChild&&c.currentChild.getId()!=="start"&&(c.currentChild.hidePage(function(){}),c.currentChild=null,c.currentChildO(null))},this.showChild=function(b){var d=c.currentChild;c.currentChild=null;var e=!1,f=b[0],g=null;_.each(a(),function(a){if(!e){var b=a.getId();if(b===f||(f===""||f==null)&&b==="start")e=!0,c.currentChild=a;b==="?"&&(g=a)}});var h=!1,i=c;while(!c.currentChild&&i.page.parentPage&&!i.page.getValue().modal){var j=i.page.parentPage.children;_.each(j(),function(a){if(!e){var b=a.getId(),d=a.getValue().modal;if(d){if(b===f||(f===""||f==null)&&b==="start")e=!0,c.currentChild=a,h=!0;b==="?"&&!g&&(g=a,h=!0)}}}),c.currentChild||(i=i.page.parentPage.childManager)}!c.currentChild&&g&&(c.currentChild=g,c.currentChild.currentId=f),c.currentChild&&(c.currentChildO(c.currentChild),h?c.currentChild.currentParentPage(c.page):c.currentChild.currentParentPage(null)),d&&d===c.currentChild?c.currentChild.showPage(b.slice(1)):d?d.hidePage(function(){c.currentChild&&c.currentChild.showPage(b.slice(1))}):c.currentChild&&c.currentChild.showPage(b.slice(1))}},pager.start=function(a){var b=function(){pager.routeFromHashToPage(window.location.hash)};$(window).bind("hashchange",b),b()},pager.extendWithPage=function(a){a.$page=new pager.Page,pager.childManager=new pager.ChildManager(a.$page.children,a.$page),a.$page.childManager=pager.childManager},pager.routeFromHashToPage=function(a){a[0]==="#"&&(a=a.slice(1));var b=a.split("/");pager.childManager.showChild(b)},pager.Page=function(a,b,c,d,e){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=c,this.viewModel=d,this.bindingContext=e,this.children=ko.observableArray([]),this.childManager=new pager.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.currentParentPage=ko.observable(null)},pager.Page.prototype.showPage=function(a){this.show(),this.childManager.showChild(a)},pager.Page.prototype.hidePage=function(a){this.hideElementWrapper(a),this.childManager.hideChild()},pager.Page.prototype.init=function(){var a=this.getValue();this.parentPage=this.getParentPage(),this.parentPage.children.push(this),this.hideElement(),a.source&&this.loadSource(a.source);var b=null;return a["with"]?b=_ko.value(a["with"]):a.withOnShow?b={}:b=this.viewModel,this.childBindingContext=this.bindingContext.createChildContext(b),ko.utils.extend(this.childBindingContext,{$page:this}),a.withOnShow||ko.applyBindingsToDescendants(this.childBindingContext,this.element),{controlsDescendantBindings:!0}},pager.Page.prototype.getValue=function(){return _ko.value(this.valueAccessor())},pager.Page.prototype.getParentPage=function(){return this.bindingContext.$page||this.bindingContext.$data.$page},pager.Page.prototype.getId=function(){return _ko.value(this.getValue().id)},pager.Page.prototype.sourceUrl=function(a){var b=this;return this.getId()==="?"?ko.computed(function(){return _ko.value(a).replace("{1}",b.currentId)}):ko.computed(function(){return _ko.value(a)})},pager.Page.prototype.loadSource=function(a){var b=this.getValue(),c=this,d=this.element;b.loader&&_ko.value(b.loader)(c);if(b.frame==="iframe"){var e=$("iframe",$(d));e.length===0&&(e=$("<iframe></iframe>"),$(d).append(e)),b.sourceLoaded&&e.one("load",b.sourceLoaded),ko.applyBindingsToNode(e[0],{attr:{src:this.sourceUrl(a)}})}else ko.computed(function(){var e=_ko.value(this.sourceUrl(a));$(d).load(e,function(){ko.applyBindingsToDescendants(c.childBindingContext,c.element),b.sourceLoaded&&b.sourceLoaded.apply(c,arguments)})},this)},pager.Page.prototype.show=function(a){var b=this.element,c=this.getValue();this.showElementWrapper(a),this.getValue().title&&(window.document.title=this.getValue().title),c.withOnShow&&(this.withOnShowLoaded||(this.withOnShowLoaded=!0,c.withOnShow(_.bind(function(a){var b=this.bindingContext.createChildContext(a);ko.utils.extend(b,{$page:this}),ko.applyBindingsToDescendants(b,this.element)},this)))),c.sourceOnShow&&(!c.sourceCache||!b.__pagerLoaded__||typeof c.sourceCache=="number"&&b.__pagerLoaded__+c.sourceCache*1e3<Date.now())&&(b.__pagerLoaded__=Date.now(),this.loadSource(c.sourceOnShow))},pager.Page.prototype.showElementWrapper=function(a){this.getValue().beforeShow&&this.getValue().beforeShow(this),this.showElement(a),this.getValue().afterShow&&this.getValue().afterShow(this)},pager.Page.prototype.showElement=function(a){this.getValue().showElement?this.getValue().showElement(this,a):pager.showElement?pager.showElement(this,a):$(this.element).show(a)},pager.Page.prototype.hideElementWrapper=function(a){this.getValue().beforeHide&&this.getValue().beforeHide(this),this.hideElement(a),this.getValue().afterHide&&this.getValue().afterHide(this)},pager.Page.prototype.hideElement=function(a){this.getValue().hideElement?this.getValue().hideElement(this,a):pager.hideElement?pager.hideElement(this,a):($(this.element).hide(),a&&a())},pager.Page.prototype.isVisible=function(){return $(this.element).is(":visible")},pager.Page.prototype.getFullRoute=function(){return ko.computed(function(){if(this.currentParentPage&&this.currentParentPage()){var a=this.currentParentPage().getFullRoute()();return a.push(this.getId()),a}if(this.parentPage){var a=this.parentPage.getFullRoute()();return a.push(this.getId()),a}return[]},this)},ko.bindingHandlers.page={init:function(a,b,c,d,e){var f=new pager.Page(a,b,c,d,e);return f.init()},update:function(a,b,c,d,e){}},pager.useHTML5history=!1,pager.rootURI="/",ko.bindingHandlers["page-href"]={init:function(a,b,c,d,e){var f=e.$page||e.$data.$page,g=f,h=ko.computed(function(){var c=_ko.value(b()),d=0;while(c.substring(0,3)==="../")d++,c=c.slice(3);var e=g.getFullRoute()(),f=e.slice(0,e.length-d).join("/"),h=(f===""?"":f+"/")+c,i={href:"#"+h};return $(a).attr(i),h});pager.useHTML5history&&window.history&&history.pushState&&$(a).click(function(a){a.preventDefault(),history.pushState(null,null,pager.rootURI+h()),pager.childManager.showChild(h().split("/"))})},update:function(){}},pager.PageAccordionItem=function(a,b,c,d,e){pager.Page.apply(this,arguments)},pager.PageAccordionItem.prototype=new pager.Page,pager.PageAccordionItem.prototype.getAccordionBody=function(){return $(this.element).children()[1]},pager.PageAccordionItem.prototype.hideElement=function(a){this.pageAccordionItemHidden?($(this.getAccordionBody()).slideUp(),a&&a()):(this.pageAccordionItemHidden=!0,$(this.getAccordionBody()).hide())},pager.PageAccordionItem.prototype.showElement=function(a){$(this.getAccordionBody()).slideDown(),a&&a()},ko.bindingHandlers["page-accordion-item"]={init:function(a,b,c,d,e){var f=new pager.PageAccordionItem(a,b,c,d,e);f.init()},update:function(){}};