/*! pager.js - v0.5.0 - 2012-10-07
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
define(["jquery","underscore","knockout","hashchange"],function(e,t,n){var r={};r.page=null,r.now=function(){return Date.now?Date.now():(new Date).valueOf()},r.extendWithPage=function(e){var t=new r.Page;e.$__page__=t,r.page=t},r.navigationFailed=n.observable(),r.showChild=function(e){r.page.childManager.showChild(e)};var i={};i.value=n.utils.unwrapObservable,i.arrayValue=function(e){return t.map(e,function(e){return i.value(e)})};var s=function(e){var t,n={},r=/\+/g,i=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(r," "))};while(t=i.exec(e))n[s(t[1])]=s(t[2]);return n},o=function(e){if(!e)return{name:null,params:{}};var t=e.split("?"),n=t[0],r=t[1],i={};return r&&(i=s(r)),{name:n,params:i}};r.ChildManager=function(e,s){this.currentChildO=n.observable(null);var u=this;this.page=s,this.timeStamp=r.now(),this.hideChild=function(){u.currentChild&&u.currentChild.getId()!=="start"&&(u.currentChild.hidePage(function(){}),u.currentChild=null,u.currentChildO(null))},this.showChild=function(n){this.timeStamp=r.now();var s=this.timeStamp,a=u.currentChild;u.currentChild=null;var f=!1,l=o(n[0]),c=l.name,h=null;t.each(e(),function(e){if(!f){var t=e.getId();if(t===c||(c===""||c==null)&&t==="start")f=!0,u.currentChild=e;t==="?"&&(h=e)}});var p=!1,d=u,v=function(e){if(!f){var t=e.getId(),n=e.getValue().modal;if(n){if(t===c||(c===""||c==null)&&t==="start")f=!0,u.currentChild=e,p=!0;t==="?"&&!h&&(h=e,p=!0)}}};while(!u.currentChild&&d.page.parentPage&&!d.page.getValue().modal){var m=d.page.parentPage.children;t.each(m(),v),u.currentChild||(d=d.page.parentPage.childManager)}!u.currentChild&&h&&(u.currentChild=h),u.currentChild&&(u.currentChildO(u.currentChild),p?u.currentChild.currentParentPage(u.page):u.currentChild.currentParentPage(null));var g=function(){r.navigationFailed&&r.navigationFailed({page:u.page,route:n}),u.page.getValue().navigationFailed&&i.value(u.page.getValue().navigationFailed)(u.page,n)},y=function(){var e=i.value(u.currentChild.getValue().guard);e?e(u.currentChild,n,function(){u.timeStamp===s&&u.currentChild.showPage(n.slice(1),l,n[0])},a):u.currentChild.showPage(n.slice(1),l,n[0])};a&&a===u.currentChild?y():a?a.hidePage(function(){u.currentChild?y():g()}):u.currentChild?y():g()}};var u;r.Page=function(e,t,i,s,o){this.element=e,this.valueAccessor=t,this.allBindingsAccessor=i,this.viewModel=s,this.bindingContext=o,this.children=n.observableArray([]),this.childManager=new r.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=n.observable(null),this.isVisible=n.observable(!1),this.originalRoute=n.observable(null),this.route=null};var a=r.Page.prototype;a.val=function(e){return i.value(this.getValue()[e])},a.currentChildPage=function(){return this.childManager.currentChildO},a.showPage=function(e,t,n){var r=this,i=r.currentId,s=r.pageRoute?r.pageRoute.params:null,o=r.isVisible();r.currentId=t?t.name:null,r.isVisible(!0),r.originalRoute(n),r.route=e,r.pageRoute=t,o?(r.getId()==="?"&&i!==r.currentId&&r.show(),t&&s!==t.params&&r.setParams()):(r.setParams(),r.show()),r.childManager.showChild(e)},a.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var r=this.pageRoute.params,i=this.ctx,s=this.val("params")||{};e.each(r,function(e,r){t.indexOf(s,e)!==-1&&(i[e]?i[e](r):i[e]=n.observable(r))})}},a.hidePage=function(e){this.isVisible(!1),this.hideElementWrapper(e),this.childManager.hideChild()},a.init=function(){var e=this;n.utils.domNodeDisposal.addDisposeCallback(e.element,function(){e.parentPage.children.remove(e)});var t=e.getValue();return e.parentPage=e.getParentPage(),e.parentPage.children.push(this),e.hideElement(),e.val("source")&&e.loadSource(e.val("source")),e.ctx=null,t["with"]?(e.ctx=i.value(t["with"]),e.augmentContext()):t.withOnShow?e.ctx={}:(e.ctx=e.viewModel,e.augmentContext()),e.childBindingContext=e.bindingContext.createChildContext(e.ctx),n.utils.extend(e.childBindingContext,{$page:this}),e.val("withOnShow")||n.applyBindingsToDescendants(e.childBindingContext,e.element),e.parentPage.route&&e.parentPage.route[0]===e.getId()&&e.parentPage.childManager.showChild(e.parentPage.route),{controlsDescendantBindings:!0}},a.augmentContext=function(){var t=this;t.val("params")&&e.each(this.val("params"),function(e,r){t.ctx[r]||(t.ctx[r]=n.observable())}),this.val("vars")&&e.each(this.val("vars"),function(e,r){t.ctx[e]=n.observable(r)}),this.setParams()},a.getValue=function(){return this.valueAccessor?i.value(this.valueAccessor()):{}},a.getParentPage=function(){var e=this.bindingContext;while(e){if(e.$page)return e.$page;if(e.$data&&e.$data.$__page__)return e.$data.$__page__;e=e.$parentContext}return null},a.getId=function(){return this.val("id")},a.sourceUrl=function(e){var t=this;return this.getId()==="?"?n.computed(function(){var n;return t.val("deep")?n=[t.currentId].concat(t.route).join("/"):n=t.currentId,i.value(e).replace("{1}",n)}):n.computed(function(){return i.value(e)})},a.loadSource=function(t){var s=this.getValue(),o=this,u=this.element,a=null,f=s.loader||r.loader;if(s.frame==="iframe"){var l=e("iframe",e(u));l.length===0&&(l=e("<iframe></iframe>"),e(u).append(l)),f&&(a=i.value(f)(o,l),a.load()),s.sourceLoaded&&l.one("load",function(){a&&a.unload(),s.sourceLoaded(o)}),n.applyBindingsToNode(l[0],{attr:{src:this.sourceUrl(t)}})}else f&&(a=i.value(f)(o,o.element),a.load()),n.computed(function(){var r=function(){a&&a.unload(),n.applyBindingsToDescendants(o.childBindingContext,o.element),s.sourceLoaded&&s.sourceLoaded(o),o.route&&o.childManager.showChild(o.route)};if(typeof i.value(t)=="string"){var f=i.value(this.sourceUrl(t));e(u).load(f,function(){r()})}else i.value(t)(this,function(){r()})},this)},a.show=function(e){var i=this.element,s=this;s.showElementWrapper(e),s.val("title")&&(window.document.title=s.val("title")),s.val("withOnShow")&&(!s.withOnShowLoaded||s.val("sourceCache")!==!0)&&(s.withOnShowLoaded=!0,s.val("withOnShow")(t.bind(function(e){var t=s.bindingContext.createChildContext(e);s.ctx=e,s.augmentContext(),n.utils.extend(t,{$page:this}),n.applyBindingsToDescendants(t,s.element)},this),this)),s.val("sourceOnShow")&&(!s.val("sourceCache")||!i.__pagerLoaded__||typeof s.val("sourceCache")=="number"&&i.__pagerLoaded__+s.val("sourceCache")*1e3<r.now())&&(i.__pagerLoaded__=r.now(),s.loadSource(s.val("sourceOnShow")))},a.showElementWrapper=function(e){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(e),this.val("afterShow")&&this.val("afterShow")(this)},a.showElement=function(t){this.val("showElement")?this.val("showElement")(this,t):this.val("fx")?r.fx[this.val("fx")].showElement(this,t):r.showElement?r.showElement(this,t):e(this.element).show(t)},r.Page.prototype.hideElementWrapper=function(e){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(e),this.val("afterHide")&&this.val("afterHide")(this)},a.hideElement=function(t){this.val("hideElement")?this.val("hideElement")(this,t):this.val("fx")?r.fx[this.val("fx")].hideElement(this,t):r.hideElement?r.hideElement(this,t):(e(this.element).hide(),t&&t())},a.getFullRoute=function(){return n.computed(function(){var e=null;return this.currentParentPage&&this.currentParentPage()?(e=this.currentParentPage().getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):this.parentPage?(e=this.parentPage.getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):[]},this)},a.nullObject=new r.Page,a.nullObject.children=n.observableArray([]),a.child=function(e){return n.computed(function(){var n=t.find(this.children(),function(t){return t.getId()===e});return n||this.nullObject},this)},n.bindingHandlers.page={init:function(e,t,n,i,s){var o=new r.Page(e,t,n,i,s);return o.init()}},r.useHTML5history=!1,r.rootURI="/",r.Href=function(e,t,r,i,s){this.element=e,this.bindingContext=s,this.path=n.observable(),this.val=n.observable(t)};var f=r.Href.prototype;return f.getParentPage=a.getParentPage,f.init=function(){var e=this.getParentPage();this.path=n.computed(function(){var t=i.value(this.val()());if(typeof t=="string"){var n=0;while(t.substring(0,3)==="../")n++,t=t.slice(3);var r=e.getFullRoute()(),s=r.slice(0,r.length-n).join("/"),o=(s===""?"":s+"/")+t;return o}return t.getFullRoute?t.getFullRoute()().join("/"):""},this)},r.Href.hash="#",f.bind=function(){var e=n.computed(function(){return r.Href.hash+this.path()},this);n.applyBindingsToNode(this.element,{attr:{href:e}})},f.update=function(e){this.val(e)},r.Href5=function(e,t,n,i,s){r.Href.apply(this,arguments)},r.Href5.prototype=new r.Href,r.Href5.history=window.history,r.Href5.prototype.bind=function(){n.applyBindingsToNode(this.element,{attr:{href:this.path},click:t.bind(function(){r.Href5.history.pushState(null,null,this.path())},this)})},n.bindingHandlers["page-hash"]={init:function(e,t,n,i,s){var o=new r.Href(e,t,n,i,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},n.bindingHandlers["page-href5"]={init:function(e,t,n,i,s){var o=new r.Href5(e,t,n,i,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},n.bindingHandlers["page-href"]={init:function(e,t,n,i,s){var o=r.useHTML5history?r.Href5:r.Href,u=new o(e,t,n,i,s);u.init(),u.bind(),e.__ko__page=u},update:function(e,t){e.__ko__page.update(t)}},r.fx={},r.fx.cssAsync=function(t){return{showElement:function(n,r){var i=e(n.element);i.addClass(t),i.show();var s=setInterval(function(){clearInterval(s),i.addClass(t+"-in")},10),o=setInterval(function(){clearInterval(o),r&&r()},300)},hideElement:function(n,r){var i=e(n.element);if(!n.pageHiddenOnce)n.pageHiddenOnce=!0,i.hide();else{i.removeClass(t+"-in");var s=setInterval(function(){clearInterval(s),r&&r(),i.hide()},300)}}}},r.fx.zoom=r.fx.cssAsync("pagerjs-fx-zoom"),r.fx.flip=r.fx.cssAsync("pagerjs-fx-flip"),r.fx.popout=r.fx.cssAsync("pagerjs-fx-popout-modal"),r.fx.jQuerySync=function(t,n){return{showElement:function(n,r){t.call(e(n.element),300,r)},hideElement:function(t,r){n.call(e(t.element),300,function(){e(t.element).hide()}),r&&r()}}},r.fx.slide=r.fx.jQuerySync(e.fn.slideDown,e.fn.slideUp),r.fx.fade=r.fx.jQuerySync(e.fn.fadeIn,e.fn.fadeOut),r.start=function(){e(window).hashchange(function(){var e=location.hash;e[0]==="#"&&(e=e.slice(1));var t=decodeURIComponent(e).split("/");r.showChild(t)}),e(window).hashchange()},r});