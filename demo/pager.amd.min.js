/*! pager.js - v0.3.0 - 2012-08-28
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
define(["jquery","underscore","knockout"],function(a,b,c){var d={},e={};return e.value=c.utils.unwrapObservable,e.arrayValue=function(a){return b.map(a,function(a){return e.value(a)})},d.ChildManager=function(a){var c=null;this.showChild=function(d){var e=c;c=null;var f=!1,g=d[0],h=null;b.each(a(),function(a){if(!f){var b=a.getId();if(b===g||(g===""||g==null)&&b==="start")f=!0,c=a;b==="?"&&(h=a)}});var i=!1;!c&&h&&(c=h,c.currentId=g),e?e.hidePage(function(){c&&c.showPage(d.slice(1))}):c&&c.showPage(d.slice(1))}},d.start=function(b){var c=function(){d.routeFromHashToPage(window.location.hash)};a(window).bind("hashchange",c),c()},d.extendWithPage=function(a){a.$page=new d.Page,d.childManager=new d.ChildManager(a.$page.children),a.$page.childManager=d.childManager},d.routeFromHashToPage=function(a){a[0]==="#"&&(a=a.slice(1));var b=a.split("/");d.childManager.showChild(b)},d.Page=function(a,b,e,f,g){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=e,this.viewModel=f,this.bindingContext=g,this.children=c.observableArray([]),this.childManager=new d.ChildManager(this.children),this.parentPage=null,this.currentId=null},d.Page.prototype.showPage=function(a){this.show(),this.childManager.showChild(a)},d.Page.prototype.hidePage=function(a){this.hideElementWrapper(a)},d.Page.prototype.init=function(){var a=this.getValue();this.parentPage=this.getParentPage(),this.parentPage.children.push(this),this.hideElement(),a.source&&this.loadSource(a.source);var b=null;return a["with"]?b=e.value(a["with"]):a.withOnShow?b={}:b=this.viewModel,this.childBindingContext=this.bindingContext.createChildContext(b),c.utils.extend(this.childBindingContext,{$page:this}),a.withOnShow||c.applyBindingsToDescendants(this.childBindingContext,this.element),{controlsDescendantBindings:!0}},d.Page.prototype.getValue=function(){return e.value(this.valueAccessor())},d.Page.prototype.getParentPage=function(){return this.bindingContext.$page||this.bindingContext.$data.$page},d.Page.prototype.getId=function(){return e.value(this.getValue().id)},d.Page.prototype.sourceUrl=function(a){var b=this;return this.getId()==="?"?c.computed(function(){return e.value(a).replace("{1}",b.currentId)}):c.computed(function(){return e.value(a)})},d.Page.prototype.loadSource=function(b){var d=this.getValue(),f=this,g=this.element;if(d.frame==="iframe"){var h=a("iframe",a(g));h.length===0&&(h=a("<iframe></iframe>"),a(g).append(h)),d.sourceLoaded&&h.one("load",d.sourceLoaded),c.applyBindingsToNode(h[0],{attr:{src:this.sourceUrl(b)}})}else c.computed(function(){var h=e.value(this.sourceUrl(b));a(g).load(h,function(){c.applyBindingsToDescendants(f.childBindingContext,f.element),d.sourceLoaded&&d.sourceLoaded.apply(f,arguments)})},this)},d.Page.prototype.show=function(a){var d=this.element,e=this.getValue();this.showElementWrapper(a),this.getValue().title&&(window.document.title=this.getValue().title),e.withOnShow&&(this.withOnShowLoaded||(this.withOnShowLoaded=!0,e.withOnShow(b.bind(function(a){var b=this.bindingContext.createChildContext(a);c.utils.extend(b,{$page:this}),c.applyBindingsToDescendants(b,this.element)},this)))),e.sourceOnShow&&(!e.sourceCache||!d.__pagerLoaded__||typeof e.sourceCache=="number"&&d.__pagerLoaded__+e.sourceCache*1e3<Date.now())&&(d.__pagerLoaded__=Date.now(),this.loadSource(e.sourceOnShow))},d.Page.prototype.showElementWrapper=function(a){this.getValue().beforeShow&&this.getValue().beforeShow(this),this.showElement(a),this.getValue().afterShow&&this.getValue().afterShow(this)},d.Page.prototype.showElement=function(b){this.getValue().showElement?this.getValue().showElement.call(this,b):d.showElement?d.showElement.call(this,b):a(this.element).show(b)},d.Page.prototype.hideElementWrapper=function(a){this.getValue().beforeHide&&this.getValue().beforeHide(this),this.hideElement(a),this.getValue().afterHide&&this.getValue().afterHide(this)},d.Page.prototype.hideElement=function(b){this.getValue().hideElement?this.getValue().hideElement.call(this,b):d.hideElement?d.hideElement.call(this,b):(a(this.element).hide(),b&&b())},d.Page.prototype.isVisible=function(){return a(this.element).is(":visible")},d.Page.prototype.getFullRoute=function(){if(this.parentPage){var a=this.parentPage.getFullRoute();return a.push(this.getId()),a}return[]},c.bindingHandlers.page={init:function(a,b,c,e,f){var g=new d.Page(a,b,c,e,f);return g.init()},update:function(a,b,c,d,e){}},d.useHTML5history=!1,d.rootURI="/",c.bindingHandlers["page-href"]={init:function(b,f,g,h,i){var j=i.$page||i.$data.$page,k=j,l=c.computed(function(){var c=e.value(f()),d=0;while(c.substring(0,3)==="../")d++,c=c.slice(3);var g=k.getFullRoute(),h=g.slice(0,g.length-d).join("/"),i=(h===""?"":h+"/")+c,j={href:"#"+i};return a(b).attr(j),i});d.useHTML5history&&window.history&&history.pushState&&a(b).click(function(a){a.preventDefault(),history.pushState(null,null,d.rootURI+l()),d.childManager.showChild(l().split("/"))})},update:function(){}},d.PageAccordionItem=function(a,b,c,e,f){d.Page.apply(this,arguments)},d.PageAccordionItem.prototype=new d.Page,d.PageAccordionItem.prototype.getAccordionBody=function(){return a(this.element).children()[1]},d.PageAccordionItem.prototype.hideElement=function(b){this.pageAccordionItemHidden?(a(this.getAccordionBody()).slideUp(),b&&b()):(this.pageAccordionItemHidden=!0,a(this.getAccordionBody()).hide())},d.PageAccordionItem.prototype.showElement=function(b){a(this.getAccordionBody()).slideDown(),b&&b()},c.bindingHandlers["page-accordion-item"]={init:function(a,b,c,e,f){var g=new d.PageAccordionItem(a,b,c,e,f);g.init()},update:function(){}},d});